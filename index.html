<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Plan 24 semanas - MTB Guzmán el Bueno 2026</title>
  <!-- Preload del póster para mejorar tiempo de render del fondo -->
  <link rel="preload" as="image" href="https://rtsfiles.blob.core.windows.net/manager/10961/library/root/d469756c-f28c-4769-886f-40abab03aadf.png">
  <!-- Fuentes -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Bebas+Neue&family=Montserrat:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #f8fafc;
      --card: #ffffff;
      --accent: #2b8f4a; /* verde principal */
      --accent-2: #c89b3a; /* dorado secundario */
      --text: #0f172a;
      --muted: #d1d1d6;
      --border: #e2e8f0;
    }
    html, body {
      height: 100%;
      margin: 0;
      font-family: Inter, system-ui, Segoe UI, Roboto, Helvetica Neue, Arial;
      background-color: #081019;
      background-image: linear-gradient(rgba(6,10,12,0.62), rgba(14,16,18,0.62)), url('https://rtsfiles.blob.core.windows.net/manager/10961/library/root/d469756c-f28c-4769-886f-40abab03aadf.png');
      background-size: cover;
      background-position: center center;
      background-repeat: no-repeat;
      background-attachment: fixed;
      color: var(--text);
    }
    @media (max-width: 800px) {
      html, body { background-attachment: scroll; }
      .wrap { margin: 12px auto; }
    }
    .wrap {
      max-width: 1100px;
      margin: 24px auto;
      padding: 20px;
      background: rgba(255,255,255,0.12);
      -webkit-backdrop-filter: saturate(140%) blur(10px);
      backdrop-filter: saturate(140%) blur(10px);
      border-radius: 14px;
      box-shadow: 0 10px 30px rgba(2,6,23,0.45);
      border: 1px solid rgba(255,255,255,0.08);
      background-image: linear-gradient(rgba(255,255,255,0.04), rgba(255,255,255,0.02));
    }
    header { display: flex; gap: 16px; align-items: center; justify-content: space-between; flex-wrap: wrap; }
    .header-main { flex: 1 1 auto; display: flex; flex-direction: column; align-items: center; justify-content: center; text-align: center; gap: 6px; }
    h1 { margin: 0; font-size: 1.9rem; color: var(--accent-2); font-family: 'Bebas Neue', system-ui, sans-serif; letter-spacing: 1px; text-transform: uppercase; }
    .subtitle { font-family: 'Montserrat', system-ui, sans-serif; font-weight:600; color: rgba(32, 82, 183, 0.85); }
    .event-badge { display:inline-block; background: linear-gradient(90deg, rgba(0,0,0,0.55), rgba(0,0,0,0.25)); color: #fcfcfc; padding: 8px 12px; border-radius: 8px; font-weight:700; letter-spacing: 1px; box-shadow: 0 6px 18px rgba(2,6,23,0.35); font-family: 'Bebas Neue', system-ui, sans-serif; }
    .controls { display: flex; gap: 8px; align-items: center; }
    button { background: var(--accent); border: none; padding: 8px 12px; border-radius: 8px; color: white; cursor: pointer; font-weight: 600; box-shadow: 0 4px 10px rgba(14,20,30,0.12); }
    button:hover { opacity: 0.95; }
    .muted { color: var(--muted); font-size: 0.95rem; }
    .grid { display: grid; grid-template-columns: 1fr 360px; gap: 18px; margin-top: 18px; }
    .card {
      background: linear-gradient(180deg, rgba(255,255,255,0.10), rgba(255,255,255,0.06));
      -webkit-backdrop-filter: blur(6px) saturate(120%);
      backdrop-filter: blur(6px) saturate(120%);
      border: 1px solid rgba(255,255,255,0.10);
      padding: 16px;
      border-radius: 12px;
      box-shadow: 0 6px 18px rgba(6,10,14,0.12);
      color: rgba(8,12,20,0.95);
    }
    .card.week-good { background: linear-gradient(90deg, rgba(43,143,74,0.30), rgba(43,143,74,0.06)); border: 1px solid rgba(43,143,74,0.22); color: rgba(6,8,10,0.98); }
    .card.week-moderate { background: linear-gradient(90deg, rgba(200,155,58,0.38), rgba(200,155,58,0.05)); border: 1px solid rgba(200,155,58,0.22); color: rgba(6,8,10,0.98); }
    .card.week-poor { background: linear-gradient(90deg, rgba(220,60,60,0.25), rgba(220,60,60,0.06)); border: 1px solid rgba(220,60,60,0.22); color: rgba(6,8,10,0.98); }
    .event-banner { display:flex; align-items:center; justify-content:space-between; gap:12px; padding:12px 16px; margin:14px 0 6px 0; border-radius:10px; background: linear-gradient(90deg, rgba(40,40,40,0.12), rgba(255,255,255,0.02)); border: 1px solid rgba(255,255,255,0.06); }
    .event-banner .date { font-family:'Bebas Neue', sans-serif; font-size:1.6rem; color:var(--accent-2); }
    .event-banner .loc { font-family:'Montserrat', sans-serif; font-weight:600; color:rgba(8,12,20,0.85); }
    .week-title { display: flex; justify-content: space-between; align-items: center; }
    .small { font-size: 0.9rem; color: var(--muted); }
    .sessions { display: flex; gap: 8px; flex-wrap: wrap; margin-top: 8px; }
    .session {
      padding: 6px 10px;
      background: rgba(255,255,255,0.06);
      border-radius: 10px;
      font-size: 0.9rem;
      border: 1px solid rgba(15,23,42,0.06);
      cursor: pointer;
      color: rgba(6,10,18,0.95);
      transition: transform .12s ease, box-shadow .12s ease, opacity .12s ease;
      position: relative;
      display: inline-flex;
      align-items: center;
      gap: 8px;
    }
    .session:hover { transform: translateY(-3px); box-shadow: 0 8px 20px rgba(2,6,23,0.12); }
    .session.done { background: linear-gradient(90deg, rgba(44, 207, 95, 0.14), rgba(200,155,58,0.06)); color: rgba(8,12,18,0.9); text-decoration-line: line-through; text-decoration-thickness: 3px; text-decoration-color: rgba(8,12,18,0.45); text-decoration-skip-ink: none; border: 1px solid rgba(43,143,74,0.18); box-shadow: inset 0 -2px 0 rgba(0,0,0,0.02); opacity: 0.98; pointer-events: auto; }
    .session.done::after { content: '✓'; position: absolute; right: 6px; top: 50%; transform: translateY(-50%); background: var(--accent); color: white; font-size: 0.72rem; width: 20px; height: 20px; display: inline-flex; align-items: center; justify-content: center; border-radius: 50%; box-shadow: 0 3px 8px rgba(2,6,23,0.18); }
    input, select { padding: 8px; border-radius: 8px; border: 1px solid var(--border); background: white; color: var(--text); width: 100%; }
    .note { font-size: 0.9rem; color: var(--muted); margin-top: 10px; }
    footer { margin-top: 18px; color: var(--muted); font-size: 0.85rem; }
    @media(max-width:900px){ .grid { grid-template-columns: 1fr; } }

    /* Modal styles */
    #sessionModal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:1200; }
    #sessionModal[aria-hidden="true"] { display:none; }
    .modal-overlay { position:absolute; inset:0; background:rgba(2,6,12,0.6); backdrop-filter: blur(2px); }
    .modal-card { position:relative; width:min(720px,94%); max-height:86vh; overflow:auto; padding:18px; border-radius:12px; z-index:1201; background: linear-gradient(180deg, rgba(255,255,255,0.14), rgba(255,255,255,0.10)); border:1px solid rgba(255,255,255,0.12); box-shadow:0 20px 60px rgba(2,6,12,0.6); color: #ffffff; }
    .modal-card h3, .modal-card #modalBody { color: #ffffff !important; }
    .modal-card h3 { text-align:center; }
    .modal-close { display:none !important; }
    .session-action { background:var(--accent); color:white; border:none; padding:8px 12px; border-radius:8px; cursor:pointer; }
    .modal-close-secondary { background: linear-gradient(180deg, rgba(220,60,60,0.95), rgba(190,40,40,0.95)); color: #ffffff !important; border: none !important; box-shadow: 0 6px 18px rgba(190,40,40,0.18); padding: 8px 12px; border-radius: 8px; }
    .modal-close-secondary:hover{ transform: translateY(-2px); filter:brightness(1.06); }
    @media(max-width:600px){ .modal-card{ padding:12px; } .modal-close{ right:6px; top:6px; } }
    .modal-table { width:100%; border-collapse:collapse; margin-top:10px; }
    .modal-table th, .modal-table td { padding:8px 10px; border-bottom:1px solid rgba(255,255,255,0.06); text-align:left; }
    .modal-table thead th { font-weight:700; }
    .modal-table tbody tr:nth-child(odd) { background: rgba(255,255,255,0.02); }

    #weightModal { position:fixed; inset:0; display:flex; align-items:center; justify-content:center; z-index:1200; }
    #weightModal[aria-hidden="true"]{ display:none; }
    #weightModal .modal-card { width:min(680px,94%); }
  </style>
</head>
<body>
  <div class="wrap">
    <header >
      <div class="header-main">
        <div><a class="event-badge" href="https://www.rockthesport.com/es/evento/-xxi-mtb-guzman-el-bueno-2026">21 MARZO 2026 — CÓRDOBA</a></div>
        <h1><a href="https://www.mtbguzmanelbueno.com/" style="color:inherit;text-decoration:none">Guzmán el Bueno — Plan 24 semanas</a></h1>
        <div class="subtitle muted">Llega preparado para el maratón MTB — plan progresivo, control de peso y exportación</div>
      </div>
      <div class="controls">
        <button id="resetPlan">Reiniciar plan</button>
        <button id="exportJSON">Exportar JSON</button>
        <button id="importJSON">Importar JSON</button>
        <button id="printPDF">Imprimir / Guardar PDF</button>
      </div>
    </header>

    <div class="grid">
      <main class="card" id="mainCard">
        <div class="event-banner">
          <div>
            <div class="date">21 MARZO</div>
            <div class="loc">Córdoba — Maratón MTB Guzmán el Bueno</div>
          </div>
          <div class="muted">XXI edición — ¡Prepárate con este plan de 24 semanas!</div>
        </div>
        <h2 class="small">Plan semanal (marca las sesiones completadas)</h2>
        <div id="weeksContainer"></div>
      </main>

      <aside class="card">
        <h3 class="small">Control de peso y progreso</h3>
        <label>Nueva entrada de peso (kg)</label>
        <input id="weightInput" type="number" step="0.1" placeholder="p. ej. 137.4" />
        <button id="addWeight">Añadir peso</button>
        <button id="openWeightModal" class="session-action" style="margin-left:8px;">Info nutrición</button>
        <p class="note">Pésate siempre a la misma hora y con la misma ropa para consistencia.</p>
        <h4 class="small">Registro</h4>
        <ul id="weightList" style="max-height:160px;overflow:auto;padding-left:16px;margin:0"></ul>
        <h4 class="small">Datos rápidos</h4>
        <div class="muted">Peso inicial: <span id="startWeight">—</span> kg</div>
        <div class="muted">Último peso: <span id="lastWeight">—</span> kg</div>
      </aside>
    </div>

    <footer>
      <div class="muted">Marca las sesiones completadas, añade pesos semanales y usa “Imprimir” para generar un PDF del plan y tu registro. Los datos se guardan en tu navegador (localStorage).</div>
    </footer>
  </div>

  <!-- Modal para información de sesión -->
  <div id="sessionModal" aria-hidden="true">
    <div class="modal-overlay" id="modalOverlay"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="modalTitle">
      <button class="modal-close" id="modalClose" aria-label="Cerrar">✕</button>
        <h3 id="modalTitle"></h3>
        <div id="modalBody"></div>
        <div style="display:flex;gap:8px;margin-top:14px;justify-content:flex-end;">
          <button id="modalToggleDone" class="session-action">Marcar como hecho</button>
          <button id="modalClose2" class="session-action modal-close-secondary">Cerrar</button>
        </div>
    </div>
  </div>

  <!-- Modal para control de peso y progreso -->
  <div id="weightModal" aria-hidden="true">
    <div class="modal-overlay" id="weightModalOverlay"></div>
    <div class="modal-card" role="dialog" aria-modal="true" aria-labelledby="weightModalTitle">
      <button class="modal-close" id="weightModalClose" aria-label="Cerrar">✕</button>
      <h3 id="weightModalTitle">Nutrición y control de peso</h3>
      <div id="weightModalBody" style="margin-top:10px; color:#ffffff;">
        <h4 style="color:#ffffff;margin-bottom:6px;">Nutrición enfocada al ciclista en pérdida de peso</h4>
        <ul>
          <li>Déficit leve (−300 a −500 kcal/día).</li>
          <li>Proteína alta (2 g/kg peso objetivo → 160–180 g/día).</li>
        </ul>
        <h5 style="color:#ffffff;margin-top:8px;margin-bottom:6px;">Carbohidratos estratégicos</h5>
        <ul>
          <li>Días de entrenamiento largo: más hidratos (4–6 g/kg).</li>
          <li>Días de descanso: menos (2–3 g/kg).</li>
        </ul>
        <ul>
          <li>Grasas saludables: aguacate, frutos secos, AOVE.</li>
          <li>Pesaje semanal: mismo día y hora, control visual también.</li>
        </ul>
      </div>
      <div style="display:flex;gap:8px;margin-top:14px;justify-content:flex-end;">
        <button id="weightModalClose2" class="modal-close-secondary">Cerrar</button>
      </div>
    </div>
  </div>

  <script>
    // --- Función que devuelve la descripción contextual según el título y la fase ---
    function getSessionDescription(title, phase) {
      const phases = {
        'Adaptación': {
          'Descanso activo': 'Recuperación ligera: 45–60 min caminata o rodillo muy suave (Z1). Prioriza movilidad y estiramientos. Esta semana busca reactivar sin fatigar.',
          'Rodillo/Carretera Z2 ': 'Trabajo aeróbico base: ritmo muy cómodo en Zona 2 (60–70% FCmáx). Mantén buena cadencia (85–95 rpm) y concentración en la técnica de pedaleo. Hidratación constante.',
          'Gimnasio fuerza 45–60 min': 'Primera toma de contacto: movimientos básicos (sentadilla, zancadas, planchas) con poco peso. Enfócate en la técnica y la postura. 2–3 series por ejercicio para empezar.',
          'Intervalos cortos 45–60 min': 'Introducción a la intensidad: 4–5×2 min en Z3–Z4 con recuperación completa. Objetivo: sensaciones, técnica de respiración y tolerancia al esfuerzo.',
          'Cinta/Remo 30–45 min': 'Sesión alternativa suave. Objetivo: mejorar la base aeróbica sin impacto. Mantén ritmo cómodo y control de postura.',
          'MTB técnica 2–3 h': 'Toma de contacto con la bici: trabaja equilibrio, trazadas amplias y control de freno. Evita picos de intensidad; prioriza la fluidez y la confianza.',
          'Fondo largo 2–4 h': 'Salida relajada en Z2. Sin buscar esfuerzos intensos: acumular horas cómodas, practicar postura y revisar material.'
        },
        'Base': {
          'Descanso activo': 'Rodillo o paseo muy suave (45–60 min). Movilidad y estiramientos. Recuperación activa para mantener la constancia.',
          'Rodillo/Carretera Z2 ': 'Sesión aeróbica de volumen. Mantén la cadencia en 85–95 rpm y trabaja la economía de pedaleo. Hidratación y alimentación ligera si supera 90 min.',
          'Gimnasio fuerza 45–60 min': 'Incremento moderado de cargas. Prioriza básicos: sentadilla, peso muerto, prensa y trabajo de core. 3×8–12 con técnica cuidada.',
          'Intervalos cortos 45–60 min': 'Bloque de VO₂: 5–6×3 min en Z4 con 3 min recuperación. Buen calentamiento (15–20 min) y control en las series.',
          'Cinta/Remo 30–45 min': 'Sesión cruzada moderada para mantener volumen y facilitar recuperación de piernas.',
          'MTB técnica 2–3 h': 'Más foco en subidas y trazadas. Introduce secciones de pedaleo continuo y mejora de la tracción en subida.',
          'Fondo largo 2–4 h': 'Rodaje largo con fragmentos de cadencia más alta. Practica alimentación (60–80 g/h) y bebida cada 15–20 min.'
        },
        'Fuerza/MTB': {
          'Descanso activo': 'Rodillo o paseo de 45 min (Z1). Añade foam roller y estiramientos específicos si notas rigidez.',
          'Rodillo/Carretera Z2 ': 'Sesión base con tramos en Z3: añade 2×15 min a ritmo sostenido para trabajar umbral.',
          'Gimnasio fuerza 45–60 min': 'Fase de fuerza: menos repeticiones y más carga. Ejemplo: 4–6 reps, 3–5 series en ejercicios principales. Técnica y control postural obligatorios.',
          'Intervalos cortos 45–60 min': 'Bloque intenso: 7–8×3 min en Z5 (o Z4 muy duro) con 2–3 min recuperación. Mejora potencia y tolerancia al lactato.',
          'Cinta/Remo 30–45 min': 'Regeneración activa: ritmo cómodo para estimular circulación sin sobrecargar piernas.',
          'MTB técnica 2–3 h': 'Objetivo: pasos técnicos exigentes, subidas con tracción y bajadas técnicas. Combina técnica y potencia en la bici.',
          'Fondo largo 2–4 h': 'Rodaje largo con desnivel y tramos sostenidos; trabaja alimentación y gestión de ritmos en subidas prolongadas.'
        },
        'Específica': {
          'Descanso activo': 'Descanso o 45 min muy suaves. Prioriza sueño, masaje/foam roller y nutrición para recuperación.',
          'Rodillo/Carretera Z2 ': 'Sesión específica con tramos largos en Z3 (20–30 min) para aproximar ritmo de carrera.',
          'Gimnasio fuerza 45–60 min': 'Mantenimiento (fuerza preventiva). Menor volumen, ejercicios de estabilidad y movilidad. 2 sesiones a la semana bastan.',
          'Intervalos cortos 45–60 min': 'Ritmo de carrera: 4×6 min en Z4–Z5 con 4 min recuperación. Busca consistencia bajo fatiga.',
          'Cinta/Remo 30–45 min': 'Sesión regenerativa ligera si es necesario. Mantén respiración y técnica.',
          'MTB técnica 2–3 h': 'Simulación de carrera: ritmo sostenido, subidas largas y tramos técnicos. Practica nutrición y gestión de esfuerzos.',
          'Fondo largo 2–4 h': 'Salida tipo maratón: terreno variado, ritmo controlado y alimentación idéntica a la que usarás el día del evento.'
        },
        'Puesta a punto': {
          'Descanso activo': 'Semana ligera: rodillo muy suave o paseo corto. Prioriza descanso, sueño y carga de hidratos si toca.',
          'Rodillo/Carretera Z2 ': 'Rodillo relajado con activaciones cortas: 3×2 min en Z4 para mantener chispa sin fatigar.',
          'Gimnasio fuerza 45–60 min': 'Solo movilidad, core y estiramientos. Evita cargas pesadas y sesiones extenuantes.',
          'Intervalos cortos 45–60 min': 'Activación breve: 3×3 min en Z3–Z4. Buen calentamiento y control del esfuerzo.',
          'Cinta/Remo 30–45 min': 'Regeneración o descanso activo. Escucha al cuerpo.',
          'MTB técnica 2–3 h': 'Rodaje suave con activaciones cortas; última revisión de técnica y ajuste de la bici.',
          'Fondo largo 2–4 h': 'Salida corta y cómoda; no sobrecargar. Repite la estrategia de nutrición con porciones algo menores.'
        }
      };
      return (phases[phase] && phases[phase][title]) ? phases[phase][title] : 'Descripción disponible.';
    }

    // --- Detalles enriquecidos (tabla) para gimnasio (se mantiene estático) ---
    const sessionDetails = {
      'Gimnasio fuerza 45–60 min': {
        type: 'table',
        cols: ['Ejercicio','Series x Reps','Notas'],
        rows: [
          ['Sentadillas','3×10','Control técnico, sin forzar'],
          ['Peso muerto','3×8','Fortalece core y espalda baja'],
          ['Zancadas','3×10 por pierna','Equilibrio y estabilidad'],
          ['Prensa','3×12','No más del 70% del 1RM'],
          ['Plancha frontal/lateral','3×45 s','Core fuerte = menos lesiones'],
          ['Puente glúteo','3×15','Mejora potencia en pedaleo']
        ]
      }
    };

    // --- defaultPlan: genera 24 semanas con fases (manteniendo los títulos) ---
    const defaultPlan = (() => {
      const phases = [
        {name:'Adaptación', weeks:4},
        {name:'Base', weeks:6},
        {name:'Fuerza/MTB', weeks:6},
        {name:'Específica', weeks:6},
        {name:'Puesta a punto', weeks:2}
      ];
      // Mantener los títulos tal cual (el texto del modal variará con la fase)
      const sessions = [
        'Descanso activo',
        'Rodillo/Carretera Z2',
        'Gimnasio fuerza 45–60 min',
        'Intervalos cortos',
        'Cinta/Remo 30–45 min',
        'MTB técnica',
        'Fondo largo'
      ];
      const weeks = [];
      let w = 1;
      for (const p of phases) {
        for (let i = 0; i < p.weeks; i++) {
          // cada semana guarda también la fase para usarla en las descripciones
          weeks.push({
            id: w,
            phase: p.name,
            sessions: sessions.map((s, idx) => ({ id: `w${w}s${idx+1}`, title: s, done: false }))
          });
          w++;
        }
      }
      return weeks;
    })();

    const STORAGE_KEY = 'mtb_guzman_plan_light';
    function saveState(state) { localStorage.setItem(STORAGE_KEY, JSON.stringify(state)); }
    function loadState() { const raw = localStorage.getItem(STORAGE_KEY); return raw ? JSON.parse(raw) : null; }

    const state = loadState() || { plan: defaultPlan, weights: [] };

    // --- Render weeks ---
    const weeksContainer = document.getElementById('weeksContainer');
    function renderWeeks() {
      weeksContainer.innerHTML = '';
      state.plan.forEach(week => {
        const div = document.createElement('div');
        div.className = 'card';
        div.style.marginBottom = '12px';
        const doneCount = week.sessions.filter(s => s.done).length;

        // estado visual por completitud
        div.classList.remove('week-good','week-moderate','week-poor');
        if (doneCount >= 6) div.classList.add('week-good');
        else if (doneCount >= 3 && doneCount <= 5) div.classList.add('week-moderate');
        else if (doneCount <= 2) div.classList.add('week-poor');

        div.innerHTML = `<div class='week-title'><div><strong>Semana ${week.id}</strong> <span class='small'>(${week.phase})</span></div><div class='small'>${doneCount}/${week.sessions.length} sesiones</div></div><div class='sessions' id='w${week.id}'></div>`;
        weeksContainer.appendChild(div);
        const sessionsDiv = div.querySelector(`#w${week.id}`);
        week.sessions.forEach(s => {
          const btn = document.createElement('button');
          btn.className = 'session';
          btn.textContent = s.title;
          if (s.done) btn.classList.add('done');
          btn.addEventListener('click', () => { openSessionModal(week, s, btn); });
          sessionsDiv.appendChild(btn);
        });
      });
    }

    // --- Modal logic ---
    const modal = document.getElementById('sessionModal');
    const modalOverlay = document.getElementById('modalOverlay');
    const modalClose = document.getElementById('modalClose');
    const modalClose2 = document.getElementById('modalClose2');
    const modalTitle = document.getElementById('modalTitle');
    const modalBody = document.getElementById('modalBody');
    const modalToggleDone = document.getElementById('modalToggleDone');
    let currentSessionRef = null;

    function openSessionModal(week, sessionObj, btnEl) {
      currentSessionRef = { week, sessionObj, btnEl };
      modalTitle.textContent = sessionObj.title;

      // detalle enriquecido para gimnasio si corresponde
      const detail = sessionDetails[sessionObj.title];
      if (detail && detail.type === 'table') {
        let html = '<table class="modal-table"><thead><tr>' + detail.cols.map(c => `<th>${c}</th>`).join('') + '</tr></thead><tbody>' + detail.rows.map(r => `<tr>${r.map(c => `<td>${c}</td>`).join('')}</tr>`).join('') + '</tbody></table>';
        // además también mostramos la descripción contextual encima
        html = `<div style="margin-bottom:10px;color:#ffffff">${getSessionDescription(sessionObj.title, week.phase)}</div>` + html;
        modalBody.innerHTML = html;
      } else {
        // descripción contextual según la fase
        modalBody.innerHTML = `<div style="color:#ffffff">${getSessionDescription(sessionObj.title, week.phase)}</div>`;
      }
      modalToggleDone.textContent = sessionObj.done ? 'Desmarcar' : 'Marcar como hecho';
      modal.setAttribute('aria-hidden', 'false');
      setTimeout(() => modalToggleDone.focus(), 100);
    }

    function closeModal() {
      modal.setAttribute('aria-hidden', 'true');
      currentSessionRef = null;
    }

    modalOverlay.addEventListener('click', closeModal);
    modalClose && modalClose.addEventListener('click', closeModal);
    modalClose2 && modalClose2.addEventListener('click', closeModal);

    modalToggleDone.addEventListener('click', () => {
      if (!currentSessionRef) return;
      const { week, sessionObj } = currentSessionRef;
      sessionObj.done = !sessionObj.done;
      saveState(state);
      renderWeeks();
      closeModal();
    });

    // --- Weight modal handlers ---
    const weightModal = document.getElementById('weightModal');
    const weightModalOverlay = document.getElementById('weightModalOverlay');
    const weightModalClose = document.getElementById('weightModalClose');
    const weightModalClose2 = document.getElementById('weightModalClose2');
    document.getElementById('openWeightModal').addEventListener('click', () => { weightModal.setAttribute('aria-hidden', 'false'); setTimeout(() => weightModalClose2.focus(), 80); });
    weightModalOverlay.addEventListener('click', () => weightModal.setAttribute('aria-hidden', 'true'));
    weightModalClose.addEventListener('click', () => weightModal.setAttribute('aria-hidden', 'true'));
    weightModalClose2.addEventListener('click', () => weightModal.setAttribute('aria-hidden', 'true'));
    document.addEventListener('keydown', (e) => { if (e.key === 'Escape') { if (weightModal.getAttribute('aria-hidden') === 'false') weightModal.setAttribute('aria-hidden', 'true'); } });

    // --- Weight log ---
    const weightInput = document.getElementById('weightInput');
    const addWeightBtn = document.getElementById('addWeight');
    const weightList = document.getElementById('weightList');
    const startWeightSpan = document.getElementById('startWeight');
    const lastWeightSpan = document.getElementById('lastWeight');

    function renderWeights() {
      weightList.innerHTML = '';
      state.weights.sort((a, b) => new Date(a.date) - new Date(b.date));
      state.weights.forEach(w => {
        const li = document.createElement('li');
        li.textContent = `${new Date(w.date).toLocaleDateString()} — ${w.weight.toFixed(1)} kg`;
        weightList.appendChild(li);
      });
      startWeightSpan.textContent = state.weights.length ? state.weights[0].weight.toFixed(1) : '—';
      lastWeightSpan.textContent = state.weights.length ? state.weights[state.weights.length - 1].weight.toFixed(1) : '—';
    }

    addWeightBtn.addEventListener('click', () => {
      const v = parseFloat(weightInput.value);
      if (!v || v <= 40) { alert('Introduce un peso válido.'); return; }
      state.weights.push({ date: new Date().toISOString(), weight: v });
      saveState(state);
      weightInput.value = '';
      renderWeights();
    });

    // --- Controls: reset, import/export, print ---
    document.getElementById('resetPlan').addEventListener('click', () => {
      if (confirm('¿Reiniciar todo el plan y registros?')) {
        localStorage.removeItem(STORAGE_KEY); location.reload();
      }
    });

    document.getElementById('exportJSON').addEventListener('click', () => {
      const blob = new Blob([JSON.stringify(state, null, 2)], { type: 'application/json' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a'); a.href = url; a.download = 'mtb_guzman_plan.json'; a.click(); URL.revokeObjectURL(url);
    });

    document.getElementById('importJSON').addEventListener('click', async () => {
      const file = await new Promise(r => { const i = document.createElement('input'); i.type = 'file'; i.accept = 'application/json'; i.onchange = () => r(i.files[0]); i.click(); });
      if (!file) return;
      const text = await file.text();
      try { const obj = JSON.parse(text); state.plan = obj.plan || state.plan; state.weights = obj.weights || state.weights; saveState(state); renderWeeks(); renderWeights(); alert('Importado con éxito'); } catch (e) { alert('JSON inválido'); }
    });

    document.getElementById('printPDF').addEventListener('click', () => window.print());

    // --- Init render and save initial state ---
    renderWeeks(); renderWeights(); saveState(state);
  </script>
</body>
</html>
